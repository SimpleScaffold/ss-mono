#!/bin/sh

# 1. 환경 진단 및 Windows 환경 대응
# WSL이 설치되어 있고, 현재 환경이 WSL 외부(Windows)인 경우
if command -v wsl.exe >/dev/null 2>&1 && [ -z "$WSL_DISTRO_NAME" ]; then
    echo "Environment: Windows detected. Proxying to WSL..."
    
    # 현재 Windows 경로를 WSL 경로로 변환 (C:\ -> /mnt/c/)
    WSL_PATH=$(wsl.exe wslpath -u "$(pwd)" | tr -d '\r')
    
    # 1단계: WSL 내의 zsh 대화형 쉘로 yarn 경로 탐색 (NVM 환경 등 고려)
    YARN_ABS_PATH=$(wsl.exe zsh -ic "which yarn" 2>/dev/null | tr -d '\r')
    
    # 2단계: 실패 시 NVM 기본 경로에서 직접 탐색
    if [ -z "$YARN_ABS_PATH" ] || echo "$YARN_ABS_PATH" | grep -q "not found"; then
        YARN_ABS_PATH=$(wsl.exe zsh -c "ls \$HOME/.nvm/versions/node/*/bin/yarn 2>/dev/null | tail -n 1" | tr -d '\r')
    fi

    if [ -n "$YARN_ABS_PATH" ] && ! echo "$YARN_ABS_PATH" | grep -q "not found"; then
        echo "Using WSL yarn at: $YARN_ABS_PATH"
        NODE_DIR=$(dirname "$YARN_ABS_PATH")
        # 찾은 절대 경로를 사용하여 WSL 환경에서 실행
        wsl.exe zsh -c "export PATH=\"$NODE_DIR:\$PATH\"; cd \"$WSL_PATH\" && \"$YARN_ABS_PATH\" lint-staged --no-stash"
        exit $?
    else
        # WSL 내부에 개발 환경이 없는 경우 윈도우 네이티브 환경에서 시도 (Fallback)
        echo "WSL environment not ready. Falling back to Windows Native..."
        if command -v yarn >/dev/null 2>&1; then
            yarn lint-staged --no-stash
            exit $?
        else
            echo "Error: yarn not found in both WSL and Windows."
            exit 1
        fi
    fi
fi

# 2. Linux / WSL 내부 환경 대응 (또는 위 조건에 해당하지 않는 경우)
# 이미 WSL 내부이거나 Linux 환경인 경우 직접 실행
yarn lint-staged --no-stash
